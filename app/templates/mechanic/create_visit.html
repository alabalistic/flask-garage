{% extends "layout.html" %}

{% block content %}
<div class="content-section">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π –ø–æ—Å–µ—â–µ–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∞: {{ car.registration_number }}</h2>
    <form id="visit-form" method="POST" action="{{ url_for('create_visit', car_id=car.id) }}" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="form-group">
            <label for="description">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–µ–º–æ–Ω—Ç–∞</label>
            {{ form.description(class="form-control") }}
            <div class="input-group mt-2">
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" id="record-button">üé§ –ó–∞–ø–æ—á–Ω–∏ –∑–∞–ø–∏—Å</button>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn btn-primary">–ó–∞–ø–∞–∑–∏</button>
    </form>
</div>

<script>
  let isRecording = false;
  let mediaRecorder;
  let audioChunks = [];

  document.getElementById('record-button').addEventListener('click', () => {
    if (isRecording) {
      mediaRecorder.stop();
      isRecording = false;
      document.getElementById('record-button').innerText = "üé§ –ó–∞–ø–æ—á–Ω–∏ –∑–∞–ø–∏—Å";
    } else {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
          mediaRecorder.start();
          isRecording = true;
          audioChunks = [];
          document.getElementById('record-button').innerText = "‚èπÔ∏è –°–ø—Ä–∏ –∑–∞–ø–∏—Å";

          mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const formData = new FormData();
            formData.append('audio', audioBlob, 'audio.webm');

            fetch('{{ url_for("speech_to_text") }}', {
              method: 'POST',
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.transcript) {
                document.getElementById('description').value = data.transcript;
              } else {
                alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è—Ç–∞: ' + data.error);
              }
            })
            .catch(error => console.error('Error:', error));
          };
        })
        .catch(error => {
          console.error('Error accessing audio stream:', error);
          alert('Error accessing audio stream. Please check your microphone permissions.');
        });
    }
  });
</script>
{% endblock %}
